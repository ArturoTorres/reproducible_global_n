<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arturo Torres">

<title>ReSANGloW:</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="global_n_files/libs/clipboard/clipboard.min.js"></script>
<script src="global_n_files/libs/quarto-html/quarto.js"></script>
<script src="global_n_files/libs/quarto-html/popper.min.js"></script>
<script src="global_n_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="global_n_files/libs/quarto-html/anchor.min.js"></script>
<link href="global_n_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="global_n_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="global_n_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="global_n_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="global_n_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="global_n.pdf"><i class="bi bi-file-pdf"></i>Beamer</a></li></ul></div></div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ReSANGloW:</h1>
<p class="subtitle lead">A Reproducible Spatial Analysis for Charting Nitrogen Dynamics in Global Wheat Production</p>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Arturo Torres </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            LIST, ERIN
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Wednesday, October 18, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="goal" class="level2">
<h2 class="anchored" data-anchor-id="goal">Goal</h2>
<ul>
<li><p>Following the indications, the goal of this reproducible code is to (IIASA-BNR, 2023, assignment):</p>
<ul>
<li><p>“Combine various datasets to generate indictors of nitrogen loss to the environment associated with wheat production at various spatial scales”</p></li>
<li><p>“Provide graphical representations and conduct simple comparisons across a few countries”</p></li>
<li><p>“Provide a reproducible code associated to these tasks.”</p></li>
</ul></li>
</ul>
</section>
<section id="task-1" class="level2">
<h2 class="anchored" data-anchor-id="task-1">Task 1</h2>
<ul>
<li><p>Using SPAM raster data <span class="citation" data-cites="wood-sichra_spatial_2016">(<a href="#ref-wood-sichra_spatial_2016" role="doc-biblioref">Wood-Sichra, Joglekar, and You 2016</a>)</span>, a new raster at the same resolution, containing wheat production volume (in million tons Mt) is produced.</p></li>
<li><p>Global scale in a raster format (5 arcminute spatial resolution) estimates of yield in Kg/Ha, physical area in Ha and harvested area in Ha for the year 2005 are available.</p></li>
</ul>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>terra 1.7.18</code></pre>
</div>
</div>
</section>
<section id="reading-spam-data" class="level2">
<h2 class="anchored" data-anchor-id="reading-spam-data">Reading SPAM data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>spam_data <span class="ot">=</span> <span class="fu">list</span>(<span class="st">"yield"</span> <span class="ot">=</span> <span class="fu">rast</span>(<span class="st">"data/SPAM_2005_v3.2/SPAM2005V3r2_global_Y_TA_WHEA_A.tif"</span>),</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"harvested_area"</span> <span class="ot">=</span> <span class="fu">rast</span>(<span class="st">"data/SPAM_2005_v3.2/SPAM2005V3r2_global_H_TA_WHEA_A.tif"</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"physical_area"</span> <span class="ot">=</span> <span class="fu">rast</span>(<span class="st">"data/SPAM_2005_v3.2/SPAM2005V3r2_global_A_TA_WHEA_A.tif"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(spam_data)   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ yield         :S4 class 'SpatRaster' [package "terra"]
 $ harvested_area:S4 class 'SpatRaster' [package "terra"]
 $ physical_area :S4 class 'SpatRaster' [package "terra"]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>spam_data[[<span class="st">'yield'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatRaster 
dimensions  : 1853, 4320, 1  (nrow, ncol, nlyr)
resolution  : 0.08333333, 0.08333333  (x, y)
extent      : -180, 180, -64.41667, 90  (xmin, xmax, ymin, ymax)
coord. ref. : lon/lat WGS 84 (EPSG:4326) 
source      : SPAM2005V3r2_global_Y_TA_WHEA_A.tif 
name        : SPAM2005V3r2_global_Y_TA_WHEA_A 
min value   :                               0 
max value   :                           19429 </code></pre>
</div>
</div>
</section>
<section id="calculate-wheat-production" class="level2">
<h2 class="anchored" data-anchor-id="calculate-wheat-production">Calculate Wheat Production</h2>
<ul>
<li><p>Calculate wheat production by multiplying the raster layers for yield (in Kg/Ha) and harvested area (in Ha) using the * operator:</p>
<ul>
<li>wheat_production = spam_data[[“yield”]] * spam_data[[“harvested_area”]]</li>
</ul></li>
<li><p>Convert Units: The resulting values are in Kg, so it is needed to convert them to million tons (Mt). Assuming 1 ton is equal to 1,000 Kg, it is possible to use the following:</p>
<ul>
<li>wheat_production_Mt = wheat_production / (1e3 * 1e6)</li>
</ul></li>
</ul>
</section>
<section id="calculate-wheat-production-1" class="level2">
<h2 class="anchored" data-anchor-id="calculate-wheat-production-1">Calculate Wheat Production</h2>
<ul>
<li>A global map is created and the raster is exported in a geotif format:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>wheat_production <span class="ot">=</span> spam_data[[<span class="st">"yield"</span>]] <span class="sc">*</span> spam_data[[<span class="st">"harvested_area"</span>]]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>wheat_production_Mt <span class="ot">&lt;-</span> wheat_production <span class="sc">/</span> (<span class="fl">1e9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: sp</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">writeRaster</span>(wheat_production_Mt, <span class="at">filename =</span> <span class="st">"./output/wheat_production_Mt.tif"</span>, </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">overwrite=</span><span class="cn">TRUE</span>, <span class="at">gdal =</span> <span class="fu">c</span>(<span class="st">"COMPRESS=DEFLATE"</span>, <span class="st">"TFW=YES"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wheat-production-in-mt-in-2005" class="level2">
<h2 class="anchored" data-anchor-id="wheat-production-in-mt-in-2005">Wheat Production in Mt in 2005</h2>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'scales'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:terra':

    rescale</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: viridisLite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'viridis'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:scales':

    viridis_pal</code></pre>
</div>
<div class="cell-output-display">
<p><img src="global_n_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="task-2" class="level2">
<h2 class="anchored" data-anchor-id="task-2">Task 2</h2>
<ul>
<li>Using the newly created raster and the GAUL shapefile of administrative borders, the production is aggregated to country level and exported to a csv file.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgdal)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Please note that rgdal will be retired during 2023,
plan transition to sf/stars/terra functions using GDAL and PROJ
at your earliest convenience.
See https://r-spatial.org/r/2022/04/12/evolution.html and https://github.com/r-spatial/evolution
rgdal: version: 1.6-5, (SVN revision 1199)
Geospatial Data Abstraction Library extensions to R successfully loaded
Loaded GDAL runtime: GDAL 3.5.3, released 2022/10/21
Path to GDAL shared files: /Users/torres/Library/R/arm64/4.2/library/sf/gdal
 GDAL does not use iconv for recoding strings.
GDAL binary built with GEOS: TRUE 
Loaded PROJ runtime: Rel. 9.1.0, September 1st, 2022, [PJ_VERSION: 910]
Path to PROJ shared files: /Users/torres/Library/R/arm64/4.2/library/rgdal/proj
PROJ CDN enabled: FALSE
Linking to sp version:1.6-0
To mute warnings of possible GDAL/OSR exportToProj4() degradation,
use options("rgdal_show_exportToProj4_warnings"="none") before loading sp or rgdal.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'rgdal'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:terra':

    project</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgeos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>rgeos version: 0.6-2, (SVN revision 693)
 GEOS runtime version: 3.11.0-CAPI-1.17.0 
 Please note that rgeos will be retired during 2023,
plan transition to sf functions using GEOS at your earliest convenience.
 GEOS using OverlayNG
 Linking to sp version: 1.6-0 
 Polygon checking: TRUE </code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>gaul_data_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/GAUL/g2015_2005_2.shp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `g2015_2005_2' from data source 
  `/Users/torres/Documents/02_working/3-Production/05_models/32_iiasa/global_n/data/GAUL/g2015_2005_2.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 38189 features and 12 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -180 ymin: -89.9 xmax: 180 ymax: 83.62742
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>gaul_data_sp <span class="ot">&lt;-</span> <span class="fu">readOGR</span>(<span class="at">dsn =</span> <span class="st">"./data/GAUL"</span>, <span class="at">layer =</span> <span class="st">"g2015_2005_2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: OGR support is provided by the sf and terra packages among others</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: OGR support is provided by the sf and terra packages among others</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: OGR support is provided by the sf and terra packages among others</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: OGR support is provided by the sf and terra packages among others</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: OGR support is provided by the sf and terra packages among others</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: OGR support is provided by the sf and terra packages among others</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>OGR data source with driver: ESRI Shapefile 
Source: "/Users/torres/Documents/02_working/3-Production/05_models/32_iiasa/global_n/data/GAUL", layer: "g2015_2005_2"
with 38189 features
It has 12 fields</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>gaul_lev0 <span class="ot">&lt;-</span> <span class="fu">levels</span>(<span class="fu">factor</span>(gaul_data_sp<span class="sc">@</span>data[,<span class="st">"ADM0_NAME"</span>]))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">lapply</span>(gaul_lev0, <span class="cf">function</span>(x) <span class="fu">which</span>(gaul_data_sp<span class="sc">@</span>data[,<span class="st">"ADM0_NAME"</span>] <span class="sc">==</span> x))</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sp_join &lt;- as(gaul_data_sp, "SpatialPolygons")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ```{r parallel-join, echo=TRUE, eval=compute_agg}</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Parallel computation</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: foreach</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: iterators</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>ncores <span class="ot">=</span> <span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ncores = 8</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>cluster <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cluster, <span class="at">cores=</span>ncores)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterEvalQ</span>(<span class="at">cl =</span> cluster, <span class="fu">c</span>(<span class="fu">library</span>(rgeos, raster)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "rgeos"     "sp"        "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     

[[2]]
[1] "rgeos"     "sp"        "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     

[[3]]
[1] "rgeos"     "sp"        "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     

[[4]]
[1] "rgeos"     "sp"        "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     

[[5]]
[1] "rgeos"     "sp"        "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     

[[6]]
[1] "rgeos"     "sp"        "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     

[[7]]
[1] "rgeos"     "sp"        "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     

[[8]]
[1] "rgeos"     "sp"        "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterExport</span>(<span class="at">cl =</span> cluster, <span class="at">varlist =</span> <span class="fu">c</span>(<span class="st">"ids"</span>, <span class="st">"gaul_data_sp"</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>sp_join_lst <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(<span class="at">cl =</span> cluster, <span class="at">X =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ids), <span class="at">fun =</span> <span class="cf">function</span>(i) {</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">"/"</span>, <span class="fu">length</span>(ids)))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gUnionCascaded</span>(gaul_data_sp[ids[[i]],])</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(<span class="at">cl=</span>cluster)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(sp_join_lst, <span class="at">file =</span> <span class="st">"./data/sp_join_lst.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"./data/sp_join_lst.RData"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(sp_join)</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># spplot(sp_join_lst[[1]], col = "red", main = gaul_lev0[1]) # Afganistan</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">spplot</span>(sp_join_lst[[<span class="dv">57</span>]], <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">main =</span> gaul_lev0[<span class="dv">57</span>]) <span class="co"># Colombia</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="global_n_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">spplot</span>(sp_join_lst[[<span class="dv">148</span>]], <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">main =</span> gaul_lev0[<span class="dv">148</span>]) <span class="co"># Luxemburgo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="global_n_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># spplot(sp_join_lst[[10]], col = "red", main = gaul_lev0[10]) # Antigua y Barbuda</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this chunk is not required (eval = TRUE only if a raster splitted per country is needed)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(sp_join_lst[[<span class="dv">1</span>]])</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(compute_agg <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(pbapply)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(parallel)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(doParallel)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  ncores <span class="ot">=</span> <span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ncores = 8</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  cluster <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">registerDoParallel</span>(cluster, <span class="at">cores=</span>ncores)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clusterEvalQ</span>(<span class="at">cl =</span> cluster, <span class="fu">c</span>(<span class="fu">library</span>(rgeos, raster)))</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clusterExport</span>(<span class="at">cl =</span> cluster, <span class="at">varlist =</span> <span class="fu">c</span>(<span class="st">"sp_join_lst"</span>, <span class="st">"wheat_production_raster"</span>, <span class="st">"rasterize"</span>))</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>raster_lst <span class="ot">&lt;-</span> <span class="fu">parLapply</span>(<span class="at">cl =</span> cluster, <span class="at">X =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sp_join_lst), <span class="at">fun =</span> <span class="cf">function</span>(i) {</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">"/"</span>, <span class="fu">length</span>(sp_join_lst)))</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rasterize</span>(sp_join_lst[[i]], wheat_production_raster)</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(<span class="at">cl=</span>cluster)</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(raster_lst, <span class="at">file =</span> <span class="st">"./output/raster_lst.RData"</span>)</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this chunk is not required (eval = TRUE only if a raster splitted per country is needed)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"./output/raster_lst.RData"</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(raster_lst[[<span class="dv">260</span>]]) <span class="co">#USA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(compute_agg <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(pbapply)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(parallel)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(doParallel)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  ncores <span class="ot">=</span> <span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ncores = 8</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  cluster <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(ncores)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">registerDoParallel</span>(cluster, <span class="at">cores=</span>ncores)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clusterEvalQ</span>(<span class="at">cl =</span> cluster, <span class="fu">c</span>(<span class="fu">library</span>(raster)))</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clusterExport</span>(<span class="at">cl =</span> cluster, <span class="at">varlist =</span> <span class="fu">c</span>(<span class="st">"sp_join_lst"</span>, <span class="st">"wheat_production_raster"</span>))</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  country_aggregated_production_lst <span class="ot">=</span> <span class="fu">parLapply</span>(<span class="at">cl =</span> cluster, <span class="at">X=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(sp_join_lst), <span class="at">fun =</span> <span class="cf">function</span>(i){</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>     raster<span class="sc">::</span><span class="fu">extract</span>(wheat_production_raster, <span class="co"># raster layer</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>       sp_join_lst[[i]],  <span class="co"># spatial polygon for extraction</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">fun=</span>sum,           <span class="co"># what to value to extract</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">df=</span><span class="cn">TRUE</span>,           <span class="co"># return a dataframe?</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">na.rm =</span> <span class="cn">TRUE</span>)      <span class="co"># remove NAs?               </span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>   })</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopCluster</span>(<span class="at">cl=</span>cluster)</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>   <span class="fu">save</span>(country_aggregated_production_lst, <span class="at">file =</span> <span class="st">"./output/country_aggregated_production_lst.RData"</span>)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>   <span class="fu">stopCluster</span>(<span class="at">cl=</span>cluster)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-a-data-frame-and-rename-columns" class="level2">
<h2 class="anchored" data-anchor-id="create-a-data-frame-and-rename-columns">Create a Data Frame and Rename Columns</h2>
<ul>
<li><p>Rename the columns to indicate the country name and the aggregated wheat production in million tons.</p></li>
<li><p>The country_production_df contains a data frame with each country’s name and its aggregated wheat production in million tons. This data frame can be used for further analysis or visualization, and export to a csv file.</p></li>
</ul>
</section>
<section id="wheat-production-top-10-most-productive-countries-in-2005" class="level2">
<h2 class="anchored" data-anchor-id="wheat-production-top-10-most-productive-countries-in-2005">Wheat Production: Top 10 Most Productive Countries in 2005</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"./output/country_aggregated_production_lst.RData"</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>country_production_df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">do.call</span>(<span class="at">what =</span> rbind, <span class="at">args =</span> country_aggregated_production_lst)) </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>country_production_df<span class="sc">$</span>ID <span class="ot">=</span> gaul_lev0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(country_production_df) <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">"Country"</span>, <span class="st">"Wheat_Production_Mt"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>top10_order <span class="ot">=</span> country_production_df[<span class="fu">order</span>(country_production_df<span class="sc">$</span>Wheat_Production_Mt, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), ]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>top10_order[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     Country Wheat_Production_Mt
52                     China            99.26530
117                    India            69.55773
260 United States of America            55.12679
206       Russian Federation            46.02241
85                    France            37.27257
46                    Canada            25.26367
93                   Germany            23.81824
189                 Pakistan            20.89733
251                   Turkey            20.83224
16                 Australia            19.30162</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(country_production_df, <span class="at">file =</span> <span class="st">"output/country_production_wheat.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="task-3" class="level2">
<h2 class="anchored" data-anchor-id="task-3">Task 3</h2>
<ul>
<li><p>To create a raster map of the nitrogen (N) output in harvested wheat yield, assuming that 2% of the harvested wheat yield consists of the N element, it is used again the “raster” package. Here are the steps to achieve this:</p>
<ul>
<li><p>Read the “wheat_production” raster created earlier in Task 1.</p></li>
<li><p>Calculate Nitrogen Output Raster: A new raster that represents the nitrogen (N) output in harvested wheat yield is created. Assuming 2% of the harvested yield is N, the following formula is used:</p>
<ul>
<li>nitrogen_output_raster = wheat_production_raster * 0.02</li>
</ul></li>
<li><p>Plot the Nitrogen Output Raster: Visualize the “nitrogen_output_raster” using the plot function from the “raster” package.</p></li>
<li><p>Export the Nitrogen Output Raster: To export the raster map of nitrogen output, the writeRaster function is used and saved in GeoTiff format.</p></li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>wheat_production_raster <span class="ot">=</span> <span class="fu">raster</span>(<span class="st">"output/wheat_production_Mt.tif"</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>nitrogen_output_raster <span class="ot">=</span> wheat_production_raster <span class="sc">*</span> <span class="fl">0.02</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="global-nitrogen-output" class="level2">
<h2 class="anchored" data-anchor-id="global-nitrogen-output">Global Nitrogen Output</h2>
<ul>
<li>A raster map that represents the nitrogen (N) output in the harvested wheat yield has been created, based on the assumption that 2% of the yield consists of the N element. This map will show the distribution of nitrogen output in million tons (Mt) across the Globe.</li>
</ul>
</section>
<section id="global-nitrogen-output-in-harvested-wheat-yield-in-mt-in-2005" class="level2">
<h2 class="anchored" data-anchor-id="global-nitrogen-output-in-harvested-wheat-yield-in-mt-in-2005">Global Nitrogen Output in Harvested Wheat Yield in Mt in 2005</h2>
<div class="columns">
<div class="column" style="width:95%;">
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)  <span class="co"># better colors for everyone</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggthemes) <span class="co"># theme_map()</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>df_n <span class="ot">=</span> <span class="fu">as</span>(nitrogen_output_raster, <span class="st">"SpatialPixelsDataFrame"</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>df_n <span class="ot">=</span> <span class="fu">as.data.frame</span>(df_n) </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df_n)[<span class="dv">1</span>] <span class="ot">=</span> <span class="st">"N_out"</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span>  </span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">data=</span>df_n, <span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">fill=</span>N_out), <span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_polygon(data=gaul_data_sp, aes(x=long, y=lat, group=group), fill=NA, color="grey50", size=0.25) +</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_map</span>() <span class="sc">+</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>) <span class="sc">+</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.width=</span><span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"cm"</span>))  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="global_n_files/figure-html/nitrogen-output-plot-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ggtitle("Nitrogen Output in Harvested Wheat Yield in Mt for 2005") </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>raster<span class="sc">::</span><span class="fu">writeRaster</span>(nitrogen_output_raster, <span class="at">filename =</span> <span class="st">"output/nitrogen_output.tif"</span>, <span class="at">format =</span> <span class="st">"GTiff"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="task-4" class="level2">
<h2 class="anchored" data-anchor-id="task-4">Task 4</h2>
<ul>
<li><p>Using the dataset of country-level nitrogen use efficiency (NUE) of wheat from <span class="citation" data-cites="zhang_managing_2015">(<a href="#ref-zhang_managing_2015" role="doc-biblioref">Zhang et al. 2015</a>)</span>, and steps from previous tasks:</p>
<ul>
<li><ol type="a">
<li>For the 10 biggest wheat producers the country-level values of N output in harvested wheat, as well as related total N inputs and N losses (i.e., surplus) is estimated, and exported the dataset as a csv file</li>
</ol></li>
<li><ol start="2" type="a">
<li>The N outputs and losses for these 10 countries are summarized in one figure (plot exported as pdf file)</li>
</ol></li>
</ul></li>
</ul>
</section>
<section id="a.-estimated-and-exported-dataset-for-the-top-10-countries-by-n-outputs-and-losses" class="level2">
<h2 class="anchored" data-anchor-id="a.-estimated-and-exported-dataset-for-the-top-10-countries-by-n-outputs-and-losses">a. Estimated and Exported Dataset for the Top 10 Countries by N Outputs and Losses</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The CSV file "Country_NUE_assumption.csv" with NUE data for countries, is loaded</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>NUE_data <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"data/NUE_Zhang_et_al_2015/Country_NUE_assumption.csv"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame to store the results</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Country =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">NUE =</span> <span class="fu">double</span>(<span class="dv">0</span>),</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Production_Mt =</span> <span class="fu">double</span>(<span class="dv">0</span>), </span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_Output_Mt =</span> <span class="fu">double</span>(<span class="dv">0</span>),</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_Inputs_Mt =</span> <span class="fu">double</span>(<span class="dv">0</span>),</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_Losses_Mt =</span> <span class="fu">double</span>(<span class="dv">0</span>)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute N output for top 10 countries</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>country_aggregated_N_lst <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">as.numeric</span>(<span class="fu">row.names</span>(top10_order[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,])), <span class="cf">function</span>(i){</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>     raster<span class="sc">::</span><span class="fu">extract</span>(nitrogen_output_raster, <span class="co"># raster layer</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>       sp_join_lst[[i]],  <span class="co"># spatial polygon for extraction</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">fun=</span>sum,           <span class="co"># what to value to extract</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">df=</span><span class="cn">TRUE</span>,           <span class="co"># return a dataframe?</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">na.rm =</span> <span class="cn">TRUE</span>)      <span class="co"># remove NAs?               </span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>   })</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(country_aggregated_N_lst, <span class="at">file =</span> <span class="st">"output/country_aggregated_N_lst.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"output/country_aggregated_N_lst.RData"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the top 10 countries</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i = 1</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  country <span class="ot">=</span> top10_order<span class="sc">$</span>Country[i]</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(country <span class="sc">==</span> <span class="st">"United States of America"</span>) {</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    country_nue <span class="ot">=</span> <span class="st">"USA"</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> <span class="cf">if</span>(country <span class="sc">==</span> <span class="st">"Russian Federation"</span>) {</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    country_nue <span class="ot">=</span> <span class="st">"RussianFed"</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> country_nue <span class="ot">=</span> country</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate N output from your N output top 10 countries</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  N_Output_Mt <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(country_aggregated_N_lst[[i]][<span class="dv">2</span>]) <span class="co"># column index = 2</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract relevant data from NUE dataset</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  country_NUE <span class="ot">=</span> NUE_data[NUE_data<span class="sc">$</span>Country <span class="sc">==</span> country_nue, ]</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate N inputs from NUE dataset and </span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  N_Inputs_Mt <span class="ot">=</span> country_NUE<span class="sc">$</span>NUE <span class="sc">*</span> top10_order<span class="sc">$</span>Wheat_Production_Mt[i]</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate N losses (surplus)</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  N_Losses_Mt <span class="ot">=</span> N_Inputs_Mt <span class="sc">-</span> N_Output_Mt</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the data to the results data frame</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results, <span class="fu">data.frame</span>(<span class="at">Country =</span> country, </span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">NUE =</span> country_NUE,</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">Production_Mt =</span> top10_order<span class="sc">$</span>Wheat_Production_Mt[i],</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">N_Output_Mt =</span> N_Output_Mt, <span class="at">N_Inputs_Mt =</span> N_Inputs_Mt, <span class="at">N_Losses_Mt =</span> N_Losses_Mt))</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>results_print <span class="ot">=</span> results[,<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(results)]</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(results_print) <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>results_print[,<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(results_print)] <span class="ot">=</span> <span class="fu">round</span>(results_print[,<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(results_print)], <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'knitr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:terra':

    spin</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(results_print)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 17%">
<col style="width: 11%">
<col style="width: 20%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">NUE.Country</th>
<th style="text-align: right;">NUE.NUE</th>
<th style="text-align: right;">Production_Mt</th>
<th style="text-align: right;">N_Output_Mt</th>
<th style="text-align: right;">N_Inputs_Mt</th>
<th style="text-align: right;">N_Losses_Mt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">China</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">99.27</td>
<td style="text-align: right;">1.99</td>
<td style="text-align: right;">26.04</td>
<td style="text-align: right;">24.06</td>
</tr>
<tr class="even">
<td style="text-align: left;">India</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">69.56</td>
<td style="text-align: right;">1.39</td>
<td style="text-align: right;">17.38</td>
<td style="text-align: right;">15.99</td>
</tr>
<tr class="odd">
<td style="text-align: left;">USA</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">55.13</td>
<td style="text-align: right;">1.10</td>
<td style="text-align: right;">28.00</td>
<td style="text-align: right;">26.90</td>
</tr>
<tr class="even">
<td style="text-align: left;">RussianFed</td>
<td style="text-align: right;">0.62</td>
<td style="text-align: right;">46.02</td>
<td style="text-align: right;">0.92</td>
<td style="text-align: right;">28.48</td>
<td style="text-align: right;">27.56</td>
</tr>
<tr class="odd">
<td style="text-align: left;">France</td>
<td style="text-align: right;">0.74</td>
<td style="text-align: right;">37.27</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">27.65</td>
<td style="text-align: right;">26.91</td>
</tr>
<tr class="even">
<td style="text-align: left;">Canada</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">25.26</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">12.72</td>
<td style="text-align: right;">12.21</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Germany</td>
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">23.82</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">10.92</td>
<td style="text-align: right;">10.45</td>
</tr>
<tr class="even">
<td style="text-align: left;">Pakistan</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">20.90</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">4.18</td>
<td style="text-align: right;">3.76</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Turkey</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">20.83</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">8.80</td>
<td style="text-align: right;">8.39</td>
</tr>
<tr class="even">
<td style="text-align: left;">Australia</td>
<td style="text-align: right;">0.54</td>
<td style="text-align: right;">19.30</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">10.44</td>
<td style="text-align: right;">10.05</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print(results_print)</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Export the results to a CSV file</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(results, <span class="st">"output/results.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="b.-visualization-of-the-n-outputs-and-losses" class="level2">
<h2 class="anchored" data-anchor-id="b.-visualization-of-the-n-outputs-and-losses">b. Visualization of the N Outputs and Losses</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from the results data frame</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a data frame for plotting (N Outputs and Losses)</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">melt</span>(results[,<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">7</span>)], <span class="at">id.vars =</span> <span class="st">"NUE.Country"</span>) <span class="co"># N data in columns 1, 5 and 7</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the bar plots</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> NUE.Country, <span class="at">y =</span> value, <span class="at">fill =</span> variable)) <span class="sc">+</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"N Outputs and Losses for the Top 10 Wheat Global Producers"</span>,</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Million Tons (Mt)"</span>) <span class="sc">+</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"N_Output_Mt"</span> <span class="ot">=</span> <span class="st">"green4"</span>, <span class="st">"N_Losses_Mt"</span> <span class="ot">=</span> <span class="st">"red3"</span>)) <span class="sc">+</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="global_n_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export the plot as a PDF</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"output/results_N_outputs_losses.pdf"</span>, <span class="at">plot =</span> p, <span class="at">width =</span> <span class="dv">13</span>, <span class="at">height =</span> <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="c.-main-patterns-of-n-lossess-across-countries" class="level2">
<h2 class="anchored" data-anchor-id="c.-main-patterns-of-n-lossess-across-countries">c.&nbsp;Main Patterns of N Lossess across Countries</h2>
<ul>
<li><p>The main patterns of N losses across countries, in relation to production volume and NUE (including any singular feature) are explained in the following paragraph:</p>
<ul>
<li>In the analysis of the top 10 wheat-producing countries, varying patterns of nitrogen losses is observed. Some countries with high wheat production volumes and relatively low NUE, such as China, showed significant nitrogen losses, suggesting inefficiencies in nitrogen utilization. In contrast, countries with relative higher NUE, like Australia, exhibited lower losses despite high production. Additionally, a few countries, like France, displayed unexpected patterns of high losses compared to their NUE, potentially indicating other factors influencing nitrogen loss, such as agricultural practices or environmental conditions.</li>
</ul></li>
</ul>
</section>
<section id="task-5" class="level2">
<h2 class="anchored" data-anchor-id="task-5">Task 5</h2>
<p>In the following paragraph is explained how an analysis like the one performed in previous tasks could translate to the models within BNR’s modeling suite (https://iiasa.github.io/iBIOM/en/main/), including potential limitations.</p>
<ul>
<li>An analysis of nitrogen output, inputs, and losses in wheat production can inform IIASA BNR’s modeling suite by providing critical data inputs for assessing the environmental impacts of agricultural practices. These data help in calibrating and validating models related to land use, nutrient management, and climate change mitigation, enhancing the suite’s accuracy in predicting the effects of different agricultural scenarios on nitrogen cycling and environmental sustainability. Limitations, however, may arise from the simplifications made e.g.&nbsp;in assuming a fixed 2% nitrogen content in harvested yield, as actual values can vary. Additionally, model outcomes depend on the quality and comprehensiveness of input data, which can pose challenges in areas with limited data availability.</li>
</ul>
</section>
<section id="task-6" class="level2">
<h2 class="anchored" data-anchor-id="task-6">Task 6</h2>
<section id="issues" class="level3">
<h3 class="anchored" data-anchor-id="issues">Issues</h3>
<ul>
<li><p>In the Task 2, an implementation of the country-level aggregation step for computing the Global wheat production per country in parallel was needed due to the high computational burden reached and avoid RAM issues. Therefore, parallel pre-computed RData objects were created to be loaded in this step to render this reproducible presentation in a reasonable short time (less than three minutes), i.e.</p>
<ul>
<li><p>“./output/sp_join_lst.RData”</p></li>
<li><p>“./output/raster_lst.RData”</p></li>
<li><p>“./output/country_aggregated_production_lst.RData”</p></li>
</ul></li>
<li><p>Similarly in Task 3 the actual computation of the Global country production was coded in parallel and saved as an RData object to be loaded subsequently, i.e.</p>
<ul>
<li>“./output/country_aggregated_N_lst.RData”</li>
</ul></li>
</ul>
</section>
</section>
<section id="task-6-1" class="level2">
<h2 class="anchored" data-anchor-id="task-6-1">Task 6</h2>
<section id="assumptions" class="level3">
<h3 class="anchored" data-anchor-id="assumptions">Assumptions</h3>
<ul>
<li><p>The computations were done by using the Geodetic CRS: WGS 84.</p></li>
<li><p>The three input maps from the SPAM model for the year 2005 are global scale in raster format (5 arcminute spatial resolution):</p>
<ul>
<li>Estimates of yield in Kg/Ha,</li>
<li>Physical area in Ha,</li>
<li>Harvested area in Ha.</li>
</ul></li>
<li><p>1 ton is equal to 1,000 Kg, so 1 million ton is equal to 1,000,000,000 Kg, i.e.&nbsp;1 million ton = 1e9 Kg.</p></li>
</ul>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-wood-sichra_spatial_2016" class="csl-entry" role="listitem">
Wood-Sichra, Ulrike, Alison B Joglekar, and Liangzhi You. 2016. <span>“Spatial <span>Production</span> <span>Allocation</span> <span>Model</span> (<span>SPAM</span>) 2005: <span>Technical</span> <span>Documentation</span>.”</span>
</div>
<div id="ref-zhang_managing_2015" class="csl-entry" role="listitem">
Zhang, Xin, Eric A. Davidson, Denise L. Mauzerall, Timothy D. Searchinger, Patrice Dumas, and Ye Shen. 2015. <span>“Managing Nitrogen for Sustainable Development.”</span> <em>Nature</em> 528 (7580): 51–59. <a href="https://doi.org/10.1038/nature15743">https://doi.org/10.1038/nature15743</a>.
</div>
</div>
</section>
<section id="session-info" class="level2">
<h2 class="anchored" data-anchor-id="session-info">Session Info</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>timing.end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(timing.elapsed <span class="ot">&lt;-</span> timing.end <span class="sc">-</span> timing.ini)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 3.130984 mins</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sessioninfo)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>s_info <span class="ot">=</span> sessioninfo<span class="sc">::</span><span class="fu">session_info</span>(<span class="at">to_file =</span> <span class="st">"session_info.log"</span>, <span class="at">info =</span> <span class="st">"all"</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(s_info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.2.0 (2022-04-22)
 os       macOS 13.4.1
 system   aarch64, darwin20
 ui       X11
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       Europe/Luxembourg
 date     2023-10-18
 pandoc   3.1.8 @ /opt/homebrew/bin/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────────
 package     * version date (UTC) lib source
 class         7.3-21  2023-01-23 [2] CRAN (R 4.2.0)
 classInt      0.4-9   2023-02-28 [1] CRAN (R 4.2.0)
 cli           3.6.0   2023-01-09 [1] CRAN (R 4.2.0)
 codetools     0.2-19  2023-02-01 [2] CRAN (R 4.2.0)
 colorspace    2.1-0   2023-01-23 [1] CRAN (R 4.2.0)
 DBI           1.1.3   2022-06-18 [1] CRAN (R 4.2.0)
 digest        0.6.31  2022-12-11 [1] CRAN (R 4.2.0)
 doParallel  * 1.0.17  2022-02-07 [1] CRAN (R 4.2.0)
 dplyr         1.1.3   2023-09-03 [1] CRAN (R 4.2.0)
 e1071         1.7-13  2023-02-01 [1] CRAN (R 4.2.0)
 evaluate      0.20    2023-01-17 [1] CRAN (R 4.2.0)
 fansi         1.0.4   2023-01-22 [1] CRAN (R 4.2.0)
 farver        2.1.1   2022-07-06 [1] CRAN (R 4.2.0)
 fastmap       1.1.1   2023-02-24 [1] CRAN (R 4.2.0)
 foreach     * 1.5.2   2022-02-02 [1] CRAN (R 4.2.0)
 generics      0.1.3   2022-07-05 [1] CRAN (R 4.2.0)
 ggplot2     * 3.4.1   2023-02-10 [1] CRAN (R 4.2.0)
 ggthemes    * 4.2.4   2021-01-20 [1] CRAN (R 4.2.0)
 glue          1.6.2   2022-02-24 [1] CRAN (R 4.2.0)
 gridExtra     2.3     2017-09-09 [1] CRAN (R 4.2.0)
 gtable        0.3.1   2022-09-01 [1] CRAN (R 4.2.0)
 htmltools     0.5.4   2022-12-07 [1] CRAN (R 4.2.0)
 htmlwidgets   1.6.1   2023-01-07 [1] CRAN (R 4.2.0)
 iterators   * 1.0.14  2022-02-05 [1] CRAN (R 4.2.0)
 jsonlite      1.8.4   2022-12-06 [1] CRAN (R 4.2.0)
 KernSmooth    2.23-20 2021-05-03 [2] CRAN (R 4.2.0)
 knitr       * 1.42    2023-01-25 [1] CRAN (R 4.2.0)
 labeling      0.4.2   2020-10-20 [1] CRAN (R 4.2.0)
 lattice       0.20-45 2021-09-22 [2] CRAN (R 4.2.0)
 lifecycle     1.0.3   2022-10-07 [1] CRAN (R 4.2.0)
 magrittr      2.0.3   2022-03-30 [1] CRAN (R 4.2.0)
 munsell       0.5.0   2018-06-12 [1] CRAN (R 4.2.0)
 pbapply     * 1.7-0   2023-01-13 [1] CRAN (R 4.2.0)
 pillar        1.9.0   2023-03-22 [1] CRAN (R 4.2.0)
 pkgconfig     2.0.3   2019-09-22 [1] CRAN (R 4.2.0)
 plyr          1.8.8   2022-11-11 [1] CRAN (R 4.2.0)
 proxy         0.4-27  2022-06-09 [1] CRAN (R 4.2.0)
 purrr         1.0.1   2023-01-10 [1] CRAN (R 4.2.0)
 R6            2.5.1   2021-08-19 [1] CRAN (R 4.2.0)
 ragg          1.2.5   2023-01-12 [1] CRAN (R 4.2.0)
 raster      * 3.6-20  2023-03-06 [1] CRAN (R 4.2.0)
 Rcpp          1.0.10  2023-01-22 [1] CRAN (R 4.2.0)
 reshape2    * 1.4.4   2020-04-09 [1] CRAN (R 4.2.0)
 rgdal       * 1.6-5   2023-03-02 [1] CRAN (R 4.2.0)
 rgeos       * 0.6-2   2023-03-02 [1] CRAN (R 4.2.0)
 rlang         1.1.1   2023-04-28 [1] CRAN (R 4.2.0)
 rmarkdown     2.20    2023-01-19 [1] CRAN (R 4.2.0)
 rstudioapi    0.14    2022-08-22 [1] CRAN (R 4.2.0)
 scales      * 1.2.1   2022-08-20 [1] CRAN (R 4.2.0)
 sessioninfo * 1.2.2   2021-12-06 [1] CRAN (R 4.2.0)
 sf          * 1.0-9   2022-11-08 [1] CRAN (R 4.2.0)
 sp          * 1.6-0   2023-01-19 [1] CRAN (R 4.2.0)
 stringi       1.7.12  2023-01-11 [1] CRAN (R 4.2.0)
 stringr       1.5.0   2022-12-02 [1] CRAN (R 4.2.0)
 systemfonts   1.0.4   2022-02-11 [1] CRAN (R 4.2.0)
 terra       * 1.7-18  2023-03-06 [1] CRAN (R 4.2.0)
 textshaping   0.3.6   2021-10-13 [1] CRAN (R 4.2.0)
 tibble        3.2.1   2023-03-20 [1] CRAN (R 4.2.0)
 tidyselect    1.2.0   2022-10-10 [1] CRAN (R 4.2.0)
 units         0.8-1   2022-12-10 [1] CRAN (R 4.2.0)
 utf8          1.2.3   2023-01-31 [1] CRAN (R 4.2.0)
 vctrs         0.6.4   2023-10-12 [1] CRAN (R 4.2.0)
 viridis     * 0.6.2   2021-10-13 [1] CRAN (R 4.2.0)
 viridisLite * 0.4.1   2022-08-22 [1] CRAN (R 4.2.0)
 withr         2.5.0   2022-03-03 [1] CRAN (R 4.2.0)
 xfun          0.37    2023-01-31 [1] CRAN (R 4.2.0)
 yaml          2.3.7   2023-01-23 [1] CRAN (R 4.2.0)

 [1] /Users/torres/Library/R/arm64/4.2/library
 [2] /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/library

─ External software ──────────────────────────────────────────────────────────
 setting        value
 cairo          1.16.0
 cairoFT        2.11.1/2.13.94
 pango
 png            1.6.37
 jpeg           9.4
 tiff           LIBTIFF, Version 4.3.0
 tcl            8.6.12
 curl           7.88.1
 zlib           1.2.11
 bzlib          1.0.8, 13-Jul-2019
 xz             5.2.5
 PCRE           10.39 2021-10-29
 ICU            70.2
 TRE            TRE 0.8.0 R_fixes (BSD)
 iconv          GNU libiconv 1.11
 readline       5.2
 BLAS           /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRblas.0.dylib
 lapack         /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRlapack.dylib
 lapack_version 3.10.0

─ Python configuration ───────────────────────────────────────────────────────
 Python is not available

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>